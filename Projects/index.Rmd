---
title: ''
output: rmdformats::downcute
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidyr)
library(readxl)
library(janitor)
library(lubridate)
library(gganimate)
library(transformr)
library(ggplot2)
library(stringr)
library(gganimate)
library(gifski)
library(skimr)
library(GGally)
library(tidygeocoder)
library(caret)
library(ROCR)
library(pROC)

install.packages('ROCR')

# Load the data 
ttc <- read.csv("ttc-bus-delay-data-2022.csv")

# Clean the data 
ttc$Date <- as.Date(ttc$Date, format = "%d-%b-%y")
ttc$time_posi <- as.POSIXct(strptime(ttc$Time, format = "%H:%M"), 
                            format = "%d-%b-%y %H:%M", tz = "UTC")


ttc$time <- hour(ttc$time_posi) + (minute(ttc$time_posi)/60)

ttc <- janitor::clean_names(ttc)
```


```{r echo=FALSE, out.width="50%", fig.align='center'}
knitr::include_graphics("./Media/publictransit_TTC.png")
```

The Toronto Transit Commission (TTC) is Toronto's public transportation system. It is a vast network that covers Toronto and the surrounding municipalities, which are collectively known as the Greater Toronto Area (GTA).
#map of toronto
The bus system is particularly extensive, with routes that reach almost every corner of the city.


The TTC operates subways, buses, and streetcars throughout the region. The data for this analysis includes information on only buses. The data set is skewed because it primarily includes late buses, and does not provide a good representation of on-time buses. 

The data set contains data for the first six months of 2022, from January to June.


```{r intro, echo= FALSE, warning=FALSE}

rows_and_columns <- dim(ttc)
cat("Number of rows and columns:", rows_and_columns[1], "rows,", rows_and_columns[2], "columns\n")

# How many unique routes
unique_routes <- length(unique(ttc$route))
cat("Number of unique routes (aka busses):", unique_routes, "\n")


```


The data set contains data for the first six months of 2022, from January to June.

```{r date,echo=FALSE,warning=FALSE}
ggplot(ttc, aes(x = date, y = min_delay)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  scale_x_date(
    date_breaks = "1 month",  # Set breaks to 1 month
    date_labels = "%b %Y",    # Format labels as abbreviated month and year
    limits = c(min(ttc$date), max(ttc$date))  # Set limits based on your data
  ) +
  labs(
    title = "Relationship between Date and Bus Delay",
    x = "Date",
    y = "Min Delay"
  )

```


#Buses operate 24 hours a day, 7 days a week in Toronto. However, the bus schedule may vary depending on the day of the week and the time of year. For example, buses may run less frequently on weekends and holidays.


```{r time, echo=FALSE,warning=FALSE}

ggplot(ttc, aes(x = time_2, y = min_delay)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  # Customize x-axis breaks and labels
  scale_x_continuous(
    breaks = seq(0, 24, by = 3),  # Adjust the breaks as needed
    labels = c("12:00 AM", "3:00 AM", "6:00 AM", "9:00 AM", "12:00 PM", "3:00 PM", "6:00 PM", "9:00 PM", "12:00 AM")
  ) +
  labs(
    title = "Relationship between Time of Day and Bus Delay",
    x = "Time of Day",
    y = "Min Delay"
  )

```


During rush hour, which is typically between 7 a.m. and 9 a.m. and 5 p.m. and 7 p.m., are buses more likely to be late?

```{r busy_times,echo=FALSE}
# Create a factor for rush hour
ttc$rush_hour <- ifelse((ttc$time_2 >= 7 & ttc$time_2 <= 9) | (ttc$time_2 >= 17 & ttc$time_2 <= 19), "Rush Hour", "Non-Rush Hour")

# Visualize the relationship with rush hour times highlighted
ggplot(ttc, aes(x = time_2, y = min_delay, color = rush_hour)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  # Customize x-axis breaks and labels
  scale_x_continuous(
    breaks = seq(0, 24, by = 3),  # Adjust the breaks as needed
    labels = c("12:00 AM", "3:00 AM", "6:00 AM", "9:00 AM", "12:00 PM", "3:00 PM", "6:00 PM", "9:00 PM", "12:00 AM")
  ) +
  labs(
    title = "Relationship between Time of Day and Bus Delay",
    x = "Time of Day",
    y = "Min Delay"
  ) +
  theme_minimal()


```


The bus is most likely to be late on Sunday, with an average delay of 25 minutes. The least likely day for the bus to be late is Tuesday, with an average delay of only 17 minutes.

```{r day of week, echo=FALSE}
# On what day is the bus most likey going to be late? 
# Calculate the average delay for each day of the week?
# Create an ordered factor for days of the week
ttc$day <- factor(ttc$day, levels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

# Calculate the average delay for each day of the week
average_delays <- ttc %>%
  group_by(day) %>%
  summarise(AvgDelay = mean(min_delay, na.rm = TRUE))

# Bar plot to visualize the average delays
ggplot(average_delays, aes(x = day, y = AvgDelay)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average Delay by Day of the Week",
       x = "Day of the Week",
       y = "Average Delay (Minutes)") +
  theme_minimal()

```


```{r summary,echo=TRUE, warning=FALSE}
##model time_2
timemodel <- lm(min_delay ~ time_posi, data = ttc)

# Summary of the model
summary(timemodel)
report::report(timemodel)
```



```{r route,echo=FALSE,warning=FALSE}

# Calculate order of routes based on max min_delay
ordering <- ttc %>%
  group_by(route) %>%
  summarize(max_delay = max(min_delay)) %>%
  arrange(desc(max_delay)) %>%
  pull(route)

# Create a violin plot with ggplot2
ggplot(ttc %>% mutate(route = factor(route, levels = ordering)), aes(x = route, y = min_delay)) +
  geom_violin() +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +  # Add jittered points for better visibility
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Linear regression line
  labs(
    title = "Distribution of Bus Delay Across Routes",
    x = "Route",
    y = "Min Delay"
  ) +
  theme_minimal()

# Convert ggplot to plotly for interactivity
plotly::ggplotly()
```


Is there a particular bus route that is more late than others?

```{r pressure, echo=FALSE}
# Is a particular route more late than others?
route_mean_delays <- ttc %>%
  group_by(route) %>%
  summarise(MeanDelay = mean(min_delay, na.rm = TRUE)) %>%
  arrange(desc(MeanDelay)) %>%
  head(10)

# Create a bar plot to display the routes with the 10 highest mean delays
ggplot(route_mean_delays, aes(x = reorder(route,MeanDelay,decreasing=FALSE), y = MeanDelay)) +
  geom_bar(stat = "identity", fill = "red", color = "blue") +
  labs(
    title = "Top 10 Routes with Highest Mean Delay",
    x = "Route",
    y = "Mean Delay (Minutes)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability
```



Is there a particular bus route that is more on time than others?

```{r pressure2, echo=FALSE}
# Calculate the mean delay for each route
all_route_delay <- ttc %>%
  group_by(route) %>%
  summarise(MeanDelay = mean(min_delay))

# Sort routes by mean delay in descending order
all_route_delay_summary <- all_route_delay %>%
  arrange(desc(MeanDelay))


# what routs are on time the most often 
route_mean_on_time <- ttc %>%
  group_by(route) %>%
  summarise(MeanDelay = mean(min_delay, na.rm = FALSE)) %>%
  arrange(MeanDelay) %>%
  head(10)

# Create a bar plot to display the routes with the 10 lowest mean delays
#
ggplot(route_mean_on_time, aes(x = reorder(route,MeanDelay,decreasing=TRUE),route, y = MeanDelay)) +
  geom_bar(stat = "identity", fill = "lightgreen", color = "darkgreen") +
  labs(
    title = "Top 10 Routes with Lowest Mean Delay (Most On-Time Routes)",
    x = "Route",
    y = "Mean Delay (Minutes)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels
```























# Citations:

Data source: https://www.kaggle.com/datasets/reihanenamdari/toronto-bus-delay-2022

[1]https://en.wikipedia.org/wiki/

[2]https://arrivein.com/daily-life-in-canada/getting-around-how-to-use-public-transportation-in-toronto/

[3]https://www.prepareforcanada.com/choosing-a-city/toronto/public-transportation-system-in-torontoride-the-ttc/

[4]https://apollocover.com/magazine/toronto-public-transportation

[5]https://en.wikipedia.org/wiki/Toronto_Transit_Commission_bus_system

[6]https://travel.usnews.com/Toronto/Getting_Around/